{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/tokuhirom/apprun-dedicated-application-provisioner/schema.json",
  "title": "AppRun Dedicated Application Provisioner Configuration",
  "description": "Configuration schema for apprun-dedicated-application-provisioner",
  "type": "object",
  "required": ["clusterName", "applications"],
  "additionalProperties": false,
  "properties": {
    "clusterName": {
      "type": "string",
      "description": "Target cluster name",
      "minLength": 1
    },
    "cluster": {
      "$ref": "#/$defs/clusterSettings"
    },
    "autoScalingGroups": {
      "type": "array",
      "description": "List of auto scaling group configurations",
      "items": {
        "$ref": "#/$defs/autoScalingGroup"
      }
    },
    "loadBalancers": {
      "type": "array",
      "description": "List of load balancer configurations",
      "items": {
        "$ref": "#/$defs/loadBalancer"
      }
    },
    "applications": {
      "type": "array",
      "description": "List of application configurations",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/application"
      }
    }
  },
  "$defs": {
    "clusterSettings": {
      "type": "object",
      "description": "Cluster-level settings that can be updated",
      "additionalProperties": false,
      "properties": {
        "letsEncryptEmail": {
          "type": "string",
          "description": "Email address for Let's Encrypt certificate issuance"
        },
        "servicePrincipalId": {
          "type": "string",
          "description": "Service principal ID"
        }
      }
    },
    "autoScalingGroup": {
      "type": "object",
      "description": "Auto scaling group configuration (cannot be updated, changes require delete and recreate)",
      "required": ["name", "zone", "workerServiceClassPath", "minNodes", "maxNodes", "nameServers", "interfaces"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "ASG name (must be unique within cluster)",
          "minLength": 1
        },
        "zone": {
          "type": "string",
          "description": "Zone where the ASG is created (e.g., 'is1a')"
        },
        "workerServiceClassPath": {
          "type": "string",
          "description": "Service class path for workers"
        },
        "minNodes": {
          "type": "integer",
          "description": "Minimum number of nodes",
          "minimum": 0
        },
        "maxNodes": {
          "type": "integer",
          "description": "Maximum number of nodes",
          "minimum": 1
        },
        "nameServers": {
          "type": "array",
          "description": "List of DNS servers",
          "items": {
            "type": "string"
          }
        },
        "interfaces": {
          "type": "array",
          "description": "List of network interfaces",
          "items": {
            "$ref": "#/$defs/asgInterface"
          }
        }
      }
    },
    "asgInterface": {
      "type": "object",
      "description": "Network interface configuration for ASG",
      "required": ["interfaceIndex", "upstream"],
      "additionalProperties": false,
      "properties": {
        "interfaceIndex": {
          "type": "integer",
          "description": "Interface number (0=eth0, 1=eth1, etc.)",
          "minimum": 0
        },
        "upstream": {
          "type": "string",
          "description": "'shared' for shared segment, or switch/router ID"
        },
        "ipPool": {
          "type": "array",
          "description": "IP address pool (required unless upstream is 'shared')",
          "items": {
            "$ref": "#/$defs/ipRange"
          }
        },
        "netmaskLen": {
          "type": "integer",
          "description": "Netmask length (required unless upstream is 'shared')",
          "minimum": 1,
          "maximum": 32
        },
        "defaultGateway": {
          "type": "string",
          "description": "Default gateway IP address"
        },
        "packetFilterId": {
          "type": "string",
          "description": "Packet filter ID"
        },
        "connectsToLB": {
          "type": "boolean",
          "description": "Whether this interface connects to load balancer"
        }
      }
    },
    "loadBalancer": {
      "type": "object",
      "description": "Load balancer configuration (cannot be updated, changes require delete and recreate)",
      "required": ["name", "autoScalingGroupName", "serviceClassPath", "nameServers", "interfaces"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Load balancer name",
          "minLength": 1
        },
        "autoScalingGroupName": {
          "type": "string",
          "description": "Name of the ASG this LB belongs to"
        },
        "serviceClassPath": {
          "type": "string",
          "description": "Service class path"
        },
        "nameServers": {
          "type": "array",
          "description": "List of DNS servers",
          "items": {
            "type": "string"
          }
        },
        "interfaces": {
          "type": "array",
          "description": "List of network interfaces",
          "items": {
            "$ref": "#/$defs/lbInterface"
          }
        }
      }
    },
    "lbInterface": {
      "type": "object",
      "description": "Network interface configuration for LoadBalancer",
      "required": ["interfaceIndex", "upstream"],
      "additionalProperties": false,
      "properties": {
        "interfaceIndex": {
          "type": "integer",
          "description": "Interface number",
          "minimum": 0
        },
        "upstream": {
          "type": "string",
          "description": "'shared' for shared segment, or switch/router ID"
        },
        "ipPool": {
          "type": "array",
          "description": "IP address pool (required unless upstream is 'shared')",
          "items": {
            "$ref": "#/$defs/ipRange"
          }
        },
        "netmaskLen": {
          "type": "integer",
          "description": "Netmask length (required unless upstream is 'shared')",
          "minimum": 1,
          "maximum": 32
        },
        "defaultGateway": {
          "type": "string",
          "description": "Default gateway IP address"
        },
        "vip": {
          "type": "string",
          "description": "Virtual IP address"
        },
        "virtualRouterId": {
          "type": "integer",
          "description": "VRRP virtual router ID (required if vip is set)",
          "minimum": 1,
          "maximum": 255
        },
        "packetFilterId": {
          "type": "string",
          "description": "Packet filter ID"
        }
      }
    },
    "ipRange": {
      "type": "object",
      "description": "IP address range",
      "required": ["start", "end"],
      "additionalProperties": false,
      "properties": {
        "start": {
          "type": "string",
          "description": "Start IP address"
        },
        "end": {
          "type": "string",
          "description": "End IP address"
        }
      }
    },
    "application": {
      "type": "object",
      "description": "Application configuration",
      "required": ["name", "spec"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Application name (must be unique within cluster)",
          "minLength": 1
        },
        "spec": {
          "$ref": "#/$defs/applicationSpec"
        }
      }
    },
    "applicationSpec": {
      "type": "object",
      "description": "Application specification",
      "additionalProperties": false,
      "properties": {
        "cpu": {
          "type": "integer",
          "description": "CPU in mCPU",
          "minimum": 100,
          "maximum": 64000
        },
        "memory": {
          "type": "integer",
          "description": "Memory in MB",
          "minimum": 128,
          "maximum": 131072
        },
        "scalingMode": {
          "type": "string",
          "description": "Scaling mode",
          "enum": ["manual", "cpu"]
        },
        "fixedScale": {
          "type": "integer",
          "description": "Fixed scale count (for manual scaling mode)",
          "minimum": 1
        },
        "minScale": {
          "type": "integer",
          "description": "Minimum scale count (for cpu scaling mode)",
          "minimum": 0
        },
        "maxScale": {
          "type": "integer",
          "description": "Maximum scale count (for cpu scaling mode)",
          "minimum": 1
        },
        "scaleInThreshold": {
          "type": "integer",
          "description": "Scale in threshold percentage (for cpu scaling mode)",
          "minimum": 30,
          "maximum": 70
        },
        "scaleOutThreshold": {
          "type": "integer",
          "description": "Scale out threshold percentage (for cpu scaling mode)",
          "minimum": 50,
          "maximum": 99
        },
        "image": {
          "type": "string",
          "description": "Container image (required for new applications)"
        },
        "cmd": {
          "type": "array",
          "description": "Command to run",
          "items": {
            "type": "string"
          }
        },
        "registryUsername": {
          "type": "string",
          "description": "Container registry username"
        },
        "registryPassword": {
          "type": "string",
          "description": "Container registry password"
        },
        "registryPasswordVersion": {
          "type": "integer",
          "description": "Password version number (required when registryPassword is specified, increment to trigger password update)",
          "minimum": 1
        },
        "exposedPorts": {
          "type": "array",
          "description": "Exposed port configurations",
          "items": {
            "$ref": "#/$defs/exposedPort"
          }
        },
        "env": {
          "type": "array",
          "description": "Environment variables",
          "items": {
            "$ref": "#/$defs/envVar"
          }
        }
      }
    },
    "exposedPort": {
      "type": "object",
      "description": "Exposed port configuration",
      "required": ["targetPort", "useLetsEncrypt"],
      "additionalProperties": false,
      "properties": {
        "targetPort": {
          "type": "integer",
          "description": "Port the application listens on",
          "minimum": 1,
          "maximum": 65535
        },
        "loadBalancerPort": {
          "type": ["integer", "null"],
          "description": "External port via load balancer (null if not exposed)",
          "minimum": 1,
          "maximum": 65535
        },
        "useLetsEncrypt": {
          "type": "boolean",
          "description": "Enable Let's Encrypt for HTTPS"
        },
        "host": {
          "type": "array",
          "description": "Hostnames for HTTP/HTTPS routing",
          "items": {
            "type": "string"
          }
        },
        "healthCheck": {
          "$ref": "#/$defs/healthCheck"
        }
      }
    },
    "healthCheck": {
      "type": "object",
      "description": "Health check configuration",
      "required": ["path", "intervalSeconds", "timeoutSeconds"],
      "additionalProperties": false,
      "properties": {
        "path": {
          "type": "string",
          "description": "Health check endpoint path"
        },
        "intervalSeconds": {
          "type": "integer",
          "description": "Check interval in seconds",
          "minimum": 1
        },
        "timeoutSeconds": {
          "type": "integer",
          "description": "Check timeout in seconds",
          "minimum": 1
        }
      }
    },
    "envVar": {
      "type": "object",
      "description": "Environment variable",
      "required": ["key", "secret"],
      "additionalProperties": false,
      "properties": {
        "key": {
          "type": "string",
          "description": "Environment variable name",
          "minLength": 1
        },
        "value": {
          "type": "string",
          "description": "Environment variable value"
        },
        "secret": {
          "type": "boolean",
          "description": "Mark as secret (value cannot be retrieved via API)"
        },
        "secretVersion": {
          "type": "integer",
          "description": "Version number for secret value (required when secret is true, increment to trigger update)",
          "minimum": 1
        }
      }
    }
  }
}
